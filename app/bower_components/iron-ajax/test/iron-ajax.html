<!DOCTYPE html><html><head><title>iron-ajax</title>
    <script>if (!window.customElements) { document.write('<!--'); }</script>
    <script type="text/javascript" src="../../webcomponentsjs/custom-elements-es5-adapter.js"></script>
    <!--! do not remove -->
<script src="../../webcomponentsjs/webcomponents-lite.js"></script><script src="../../web-component-tester/browser.js"></script><link rel="import" href="../../polymer/polymer.html"><link rel="import" href="../../promise-polyfill/promise-polyfill.html"><link rel="import" href="../iron-ajax.html"></head><body><test-fixture id="TrivialGet"><template><iron-ajax url="/responds_to_get_with_json"></iron-ajax></template></test-fixture><test-fixture id="ParamsGet"><template><iron-ajax url="/responds_to_get_with_json" params="{&quot;a&quot;: &quot;a&quot;}"></iron-ajax></template></test-fixture><test-fixture id="AutoGet"><template><iron-ajax auto="" url="/responds_to_get_with_json"></iron-ajax></template></test-fixture><test-fixture id="GetEcho"><template><iron-ajax handle-as="json" url="/echoes_request_url"></iron-ajax></template></test-fixture><test-fixture id="TrivialPost"><template><iron-ajax method="POST" url="/responds_to_post_with_json"></iron-ajax></template></test-fixture><test-fixture id="DebouncedGet"><template><iron-ajax auto="" url="/responds_to_debounced_get_with_json" debounce-duration="150"></iron-ajax></template></test-fixture><test-fixture id="BlankUrl"><template><iron-ajax auto="" handle-as="text"></iron-ajax></template></test-fixture><test-fixture id="RealPost"><template><iron-ajax method="POST" url="http://httpbin.org/post"></iron-ajax></template></test-fixture><test-fixture id="Delay"><template><iron-ajax url="http://httpbin.org/delay/1"></iron-ajax></template></test-fixture><test-fixture id="Bubbles"><template><iron-ajax url="http://httpbin.org/post" method="POST" bubbles=""></iron-ajax><iron-ajax url="/responds_to_get_with_502_error_json" bubbles=""></iron-ajax></template></test-fixture><script>'use strict';suite('<iron-ajax>',function(){function a(h){return new Promise(function(j){window.setTimeout(function(){j()},h)})}function b(h){h.respond(200,c.json,JSON.stringify({url:h.url}))}var c={json:{"Content-Type":'application/json'},plain:{"Content-Type":'text/plain'}},d,f,g;setup(function(){g=sinon.fakeServer.create(),g.respondWith('GET',/\/responds_to_get_with_json.*/,[200,c.json,'{"success":true}']),g.respondWith('POST','/responds_to_post_with_json',[200,c.json,'{"post_success":true}']),g.respondWith('GET','/responds_to_get_with_text',[200,c.plain,'Hello World']),g.respondWith('GET','/responds_to_debounced_get_with_json',[200,c.json,'{"success": "true"}']),g.respondWith('GET','/responds_to_get_with_502_error_json',[502,c.json,'{"message": "an error has occurred"}']),d=fixture('TrivialGet')}),teardown(function(){g.restore()}),suite('when making simple GET requests for JSON',function(){test('has sane defaults that love you',function(){f=d.generateRequest(),g.respond(),expect(f.response).to.be.ok,expect(f.response).to.be.an('object'),expect(f.response.success).to.be.equal(!0)}),test('will be asynchronous by default',function(){expect(d.toRequestOptions().async).to.be.eql(!0)})}),suite('when setting custom headers',function(){test('are present in the request headers',function(){d.headers['custom-header']='valid';var h=d.toRequestOptions();expect(h.headers).to.be.ok,expect(h.headers['custom-header']).to.be.an('string'),expect(h.headers.hasOwnProperty('custom-header')).to.be.equal(!0)}),test('non-objects in headers are not applied',function(){d.headers='invalid';var h=d.toRequestOptions();expect(Object.keys(h.headers).length).to.be.equal(0)})}),suite('when url isn\'t set yet',function(){test('we don\'t fire any automatic requests',function(){return expect(g.requests.length).to.be.equal(0),d=fixture('BlankUrl'),a(1).then(function(){return expect(g.requests.length).to.be.equal(0),d.generateRequest(),expect(g.requests.length).to.be.equal(1),g.requests=[],d=fixture('BlankUrl'),d.url='',a(1)}).then(function(){expect(g.requests.length).to.be.equal(1)})}),test('requestUrl remains empty despite valid queryString',function(){d=fixture('BlankUrl'),expect(d.url).to.be.equal(void 0),expect(d.queryString).to.be.equal(''),expect(d.requestUrl).to.be.equal(''),d.params={a:'b',c:'d'},expect(d.queryString).to.be.equal('a=b&c=d'),expect(d.requestUrl).to.be.equal('?a=b&c=d')}),test('generateRequest works with empty URL and valid queryString',function(){d=fixture('BlankUrl'),expect(d.url).to.be.equal(void 0),d.generateRequest(),expect(g.requests[0].url).to.be.eql(''),d.params={a:'b',c:'d'},d.generateRequest(),expect(g.requests[1].url).to.be.eql('?a=b&c=d')})}),suite('when properties are changed',function(){test('generates simple-request elements that reflect the change',function(){f=d.generateRequest(),expect(f.xhr.method).to.be.equal('GET'),d.method='POST',d.url='/responds_to_post_with_json',f=d.generateRequest(),expect(f.xhr.method).to.be.equal('POST')})}),suite('when generating a request',function(){test('yields an iron-request instance',function(){var h=document.createElement('iron-request').constructor;expect(d.generateRequest()).to.be.instanceOf(h)}),test('correctly adds params to a URL that already has some',function(){d.url+='?a=b',d.params={c:'d'},expect(d.requestUrl).to.be.equal('/responds_to_get_with_json?a=b&c=d')}),test('encodes params properly',function(){d.params={"a b,c":'d e f'},expect(d.queryString).to.be.equal('a%20b%2Cc=d%20e%20f')}),test('encodes array params properly',function(){d.params={"a b":['c','d e','f']},expect(d.queryString).to.be.equal('a%20b=c&a%20b=d%20e&a%20b=f')}),test('reflects the loading state in the `loading` property',function(){var h=d.generateRequest();return expect(d.loading).to.be.equal(!0),g.respond(),h.completes.then(function(){return a(1)}).then(function(){expect(d.loading).to.be.equal(!1)})}),test('the `iron-ajax-presend` event gets fired',function(){var h=sinon.spy(),j=sinon.spy();d.addEventListener('iron-ajax-presend',h),window.addEventListener('iron-ajax-presend',j);var k=d.generateRequest();return g.respond(),k.completes.then(function(){expect(h).to.be.calledOnce,expect(j).not.to.be.called})}),test('the loading-changed event gets fired twice',function(){var h=0;d.addEventListener('loading-changed',function(){h++});var j=d.generateRequest();return g.respond(),j.completes.then(function(){return a(1)}).then(function(){expect(h).to.be.equal(2)})})}),suite('when there are multiple requests',function(){var h,j,k;setup(function(){j=fixture('GetEcho'),h=[];for(var l=0;3>l;++l)j.params={order:l+1},h.push(j.generateRequest());var m=h.map(function(n){return n.completes});k=Promise.all(m)}),test('holds all requests in the `activeRequests` Array',function(){expect(h).to.deep.eql(j.activeRequests)}),test('empties `activeRequests` when requests are completed',function(){expect(j.activeRequests.length).to.be.equal(3);for(var l=0;3>l;l++)b(g.requests[l]);return k.then(function(){return a(1)}).then(function(){expect(j.activeRequests.length).to.be.equal(0)})}),test('avoids race conditions with last response',function(){return expect(j.lastResponse).to.be.equal(void 0),b(g.requests[0]),h[0].completes.then(function(){return expect(j.lastResponse).to.be.equal(void 0),b(g.requests[2]),h[2].completes}).then(function(){return expect(j.lastResponse).to.be.deep.eql({url:'/echoes_request_url?order=3'}),b(g.requests[1]),h[1].completes}).then(function(){expect(j.lastResponse).to.be.deep.eql({url:'/echoes_request_url?order=3'})})}),test('`loading` is true while the last one is loading',function(){return expect(j.loading).to.be.equal(!0),b(g.requests[0]),h[0].completes.then(function(){return expect(j.loading).to.be.equal(!0),b(g.requests[2]),h[2].completes}).then(function(){return expect(j.loading).to.be.eql(!1),b(g.requests[1]),h[1].completes}).then(function(){expect(j.loading).to.be.eql(!1)})})}),suite('when params are changed',function(){test('generates a request that reflects the change',function(){d=fixture('ParamsGet'),f=d.generateRequest(),expect(f.xhr.url).to.be.equal('/responds_to_get_with_json?a=a'),d.params={b:'b'},f=d.generateRequest(),expect(f.xhr.url).to.be.equal('/responds_to_get_with_json?b=b')})}),suite('when `auto` is enabled',function(){setup(function(){d=fixture('AutoGet')}),test('automatically generates new requests',function(){return new Promise(function(h){d.addEventListener('request',function(){h()})})}),test('does not send requests if url is not a string',function(){return new Promise(function(h,j){d.addEventListener('request',function(){j('A request was generated but url is null!')}),d.url=null,d.handleAs='text',Polymer.Base.async(function(){h()},1)})}),test('deduplicates multiple changes to a single request',function(){return new Promise(function(h,j){d.addEventListener('request',function(){g.respond()}),d.addEventListener('response',function(){try{expect(d.activeRequests.length).to.be.eql(1),h()}catch(k){j(k)}}),d.handleas='text',d.params={foo:'bar'},d.headers={"X-Foo":'Bar'}})}),test('automatically generates new request when a sub-property of params is changed',function(h){d.addEventListener('request',function(){g.respond()}),d.params={foo:'bar'},d.addEventListener('response',function(){d.addEventListener('request',function(){h()}),d.set('params.foo','xyz')})})}),suite('the last response',function(){setup(function(){f=d.generateRequest(),g.respond()}),test('is accessible as a readonly property',function(){return f.completes.then(function(h){expect(d.lastResponse).to.be.equal(h.response)})}),test('updates with each new response',function(){return f.completes.then(function(h){return expect(h.response).to.be.an('object'),expect(d.lastResponse).to.be.equal(h.response),d.handleAs='text',h=d.generateRequest(),g.respond(),h.completes}).then(function(h){expect(h.response).to.be.a('string'),expect(d.lastResponse).to.be.equal(h.response)})})}),suite('when making POST requests',function(){setup(function(){d=fixture('TrivialPost')}),test('POSTs the value of the `body` attribute',function(){var h=JSON.stringify({foo:'bar'});d.body=h,d.generateRequest(),expect(g.requests[0]).to.be.ok,expect(g.requests[0].requestBody).to.be.equal(h)}),test('if `contentType` is set to form encode, the body is encoded',function(){d.body={foo:'bar\nbip',"biz bo":'baz blar'},d.contentType='application/x-www-form-urlencoded',d.generateRequest(),expect(g.requests[0]).to.be.ok,expect(g.requests[0].requestBody).to.be.equal('foo=bar%0D%0Abip&biz+bo=baz+blar')}),test('if `contentType` is json, the body is json encoded',function(){var h={foo:'bar',baz:[1,2,3]};d.body=h,d.contentType='application/json',d.generateRequest(),expect(g.requests[0]).to.be.ok,expect(g.requests[0].requestBody).to.be.equal(JSON.stringify(h))}),suite('the examples in the documentation work',function(){test('json content, body attribute is an object',function(){d.setAttribute('body','{"foo": "bar baz", "x": 1}'),d.contentType='application/json',d.generateRequest(),expect(g.requests[0]).to.be.ok,expect(g.requests[0].requestBody).to.be.equal('{"foo":"bar baz","x":1}')}),test('form content, body attribute is an object',function(){d.setAttribute('body','{"foo": "bar baz", "x": 1}'),d.contentType='application/x-www-form-urlencoded',d.generateRequest(),expect(g.requests[0]).to.be.ok,expect(g.requests[0].requestBody).to.be.equal('foo=bar+baz&x=1')})}),suite('and `contentType` is explicitly set to form encode',function(){test('we encode a custom object',function(){var j=new function(k){this.bar=k}('baz');d.body=j,d.contentType='application/x-www-form-urlencoded',d.generateRequest(),expect(g.requests[0]).to.be.ok,expect(g.requests[0].requestBody).to.be.equal('bar=baz')})}),suite('and `contentType` isn\'t set',function(){test('we don\'t try to encode an ArrayBuffer',function(){var h=new ArrayBuffer;d.body=h,d.generateRequest(),expect(g.requests[0]).to.be.ok,expect(g.requests[0].requestBody).to.be.equal(h)})})}),suite('when debouncing requests',function(){setup(function(){d=fixture('DebouncedGet')}),test('only requests a single resource',function(){return d._requestOptionsChanged(),expect(g.requests[0]).to.be.equal(void 0),d._requestOptionsChanged(),a(200).then(function(){expect(g.requests[0]).to.be.ok})})}),suite('when a response handler is bound',function(){var h;setup(function(){h=sinon.spy(),d.addEventListener('response',h)}),test('calls the handler after every response',function(){return d.generateRequest(),d.generateRequest(),g.respond(),d.lastRequest.completes.then(function(){expect(h.callCount).to.be.equal(2)})})}),suite('when the response type is `json`',function(){setup(function(){g.restore()}),test('finds the JSON on any platform',function(){return d.url='../bower.json',f=d.generateRequest(),f.completes.then(function(){expect(d.lastResponse).to.be.instanceOf(Object)})})}),suite('when handleAs parameter is `text`',function(){test('response type is string',function(){d.url='/responds_to_get_with_json',d.handleAs='text',f=d.generateRequest();var h=f.completes.then(function(){expect(babelHelpers.typeof(d.lastResponse)).to.be.equal('string')});return expect(g.requests.length).to.be.equal(1),expect(g.requests[0].requestHeaders.accept).to.be.equal('text/plain'),g.respond(),h})}),suite('when a request fails',function(){test('we give an error with useful details',function(){d.url='/responds_to_get_with_502_error_json',d.handleAs='json';var h=!1;d.addEventListener('error',function(l){expect(l.detail.request).to.be.ok,expect(l.detail.error).to.be.ok,h=!0});var j=d.generateRequest(),k=j.completes.then(function(){throw new Error('Expected the request to fail!')},function(l){return expect(l).to.be.instanceof(Error),expect(j.succeeded).to.be.eq(!1),a(100)}).then(function(){expect(h).to.be.eq(!0),expect(d.lastError).to.not.be.eq(null),expect(d.lastError.status).to.be.eq(502),expect(d.lastError.statusText).to.be.eq('Bad Gateway'),expect(d.lastError.response).to.be.ok});return g.respond(),k}),test('with rejectWithRequest the promise chain contains the request and error',function(){d.url='/responds_to_get_with_502_error_json',d.handleAs='json',d.rejectWithRequest=!0;var h=d.generateRequest(),j=h.completes.then(function(){throw new Error('Expected the request to fail!')},function(k){expect(k.error).to.be.instanceof(Error),expect(k.request).to.deep.equal(h)});return g.respond(),j}),test('we give a useful error even when the domain doesn\'t resolve',function(){d.url='http://nonexistant.example.com/',g.restore();var h=!1;d.addEventListener('error',function(l){expect(l.detail.request).to.be.ok,expect(l.detail.error).to.be.ok,h=!0});var j=d.generateRequest(),k=j.completes.then(function(){throw new Error('Expected the request to fail!')},function(l){return expect(j.succeeded).to.be.eq(!1),expect(l).to.not.be.eq(null),a(100)}).then(function(){expect(h).to.be.eq(!0),expect(d.lastError).to.not.be.eq(null)});return g.respond(),k})}),suite('when handleAs parameter is `json`',function(){test('response type is string',function(){d.url='/responds_to_get_with_json',d.handleAs='json',f=d.generateRequest();var h=f.completes.then(function(){expect(babelHelpers.typeof(d.lastResponse)).to.be.equal('object')});return expect(g.requests.length).to.be.equal(1),expect(g.requests[0].requestHeaders.accept).to.be.equal('application/json'),g.respond(),h})}),suite('when making a POST over the wire',function(){test('FormData is handled correctly',function(){g.restore();var h=new FormData;h.append('a','foo'),h.append('b','bar');var j=fixture('RealPost');return j.body=h,j.generateRequest().completes.then(function(){expect(j.lastResponse.headers['Content-Type']).to.match(/^multipart\/form-data; boundary=.*$/),expect(j.lastResponse.form.a).to.be.equal('foo'),expect(j.lastResponse.form.b).to.be.equal('bar')})}),test('json is handled correctly',function(){g.restore();var h=fixture('RealPost');return h.body=JSON.stringify({a:'foo',b:'bar'}),h.contentType='application/json',h.generateRequest().completes.then(function(){expect(h.lastResponse.headers['Content-Type']).to.match(/^application\/json(;.*)?$/),expect(h.lastResponse.json.a).to.be.equal('foo'),expect(h.lastResponse.json.b).to.be.equal('bar')})}),test('urlencoded data is handled correctly',function(){g.restore();var h=fixture('RealPost');return h.body='a=foo&b=bar',h.generateRequest().completes.then(function(){expect(h.lastResponse.headers['Content-Type']).to.match(/^application\/x-www-form-urlencoded(;.*)?$/),expect(h.lastResponse.form.a).to.be.equal('foo'),expect(h.lastResponse.form.b).to.be.equal('bar')})}),test('xml is handled correctly',function(){g.restore();var h=fixture('RealPost'),j=document.implementation.createDocument(null,'foo',null),k=j.createElement('bar');return k.setAttribute('name','baz'),j.documentElement.appendChild(k),h.body=j,h.generateRequest().completes.then(function(){expect(h.lastResponse.headers['Content-Type']).to.match(/^application\/xml(;.*)?$/),expect(h.lastResponse.data).to.match(/<foo\s*><bar\s+name="baz"\s*\/><\/foo\s*>/)})})}),suite('when setting timeout',function(){setup(function(){g.restore()}),test('it is present in the request xhr object',function(){d.url='/responds_to_get_with_json',d.timeout=5e3,f=d.generateRequest(),expect(f.xhr.timeout).to.be.equal(5e3)}),test('it fails once that timeout is reached',function(){var h=fixture('Delay');return h.timeout=1,f=h.generateRequest(),f.completes.then(function(){throw new Error('Expected the request to throw an error.')},function(){return expect(f.succeeded).to.be.equal(!1),expect(f.xhr.status).to.be.equal(0),expect(f.timedOut).to.be.equal(!0),a(1)}).then(function(){expect(h.loading).to.be.equal(!1),expect(h.lastResponse).to.be.equal(null),expect(h.lastError).to.not.be.equal(null)})})}),suite('when using the bubbles attribute',function(){test('the request and response events should bubble to window',function(h){function j(){k++,5===k&&h()}g.restore();var k=0;window.addEventListener('iron-ajax-presend',j),window.addEventListener('request',j),window.addEventListener('iron-ajax-request',j),window.addEventListener('response',j),window.addEventListener('iron-ajax-response',j);var l=fixture('Bubbles')[0];l.generateRequest(),g.respond()}),test('the request and error events should bubble to window',function(h){function j(){k++,5===k&&h()}var k=0;window.addEventListener('iron-ajax-presend',j),window.addEventListener('request',j),window.addEventListener('iron-ajax-request',j),window.addEventListener('error',j,!0),window.addEventListener('iron-ajax-error',j);var l=fixture('Bubbles')[1];l.generateRequest(),g.respond()})}),suite('when handling the `iron-ajax-presend` event',function(){setup(function(){g.restore()}),test('ability to cancel request',function(){var h=sinon.spy(),j=sinon.spy();d.addEventListener('iron-ajax-presend',function(l){l.preventDefault()}),d.addEventListener('iron-ajax-request',h);var k=d.generateRequest();return k.completes.catch(function(l){expect(l.aborted).to.be.true,j()}).then(function(){expect(j).to.be.calledOnce,expect(h).not.to.be.called})}),test('ability to modify the request options',function(h){d.addEventListener('iron-ajax-presend',function(j){j.detail.options.url+='/test',j.detail.options.headers.authToken='a.b.c'}),d.addEventListener('iron-ajax-request',function(j){expect(j.detail.options.url).to.equal('/responds_to_get_with_json/test'),expect(j.detail.options.headers.authToken).to.equal('a.b.c'),h()}),d.generateRequest()})})});</script></body></html>