var async=require('../lib/async'),expect=require('chai').expect;describe('compose',function(){context('all functions succeed',function(){it('yields the result of the composition of the functions',function(a){var e=async.compose(function(g,h){setTimeout(function(){h(null,g+1)})},function(g,h){setTimeout(function(){h(null,3*g)})},function(g,h){setTimeout(function(){h(null,g+2)})});e(3,function(f,g){expect(f).to.not.exist,expect(g).to.eql(16),a()})})}),context('a function errors',function(){it('yields the error and does not call later functions',function(a){var b=!1,c=new Error('mul3 error'),g=async.compose(function(i,j){b=!0,setTimeout(function(){j(null,i+1)})},function(i,j){setTimeout(function(){j(c)})},function(i,j){setTimeout(function(){j(null,i+2)})});g(3,function(h,i){expect(h).to.eql(c),expect(i).to.not.exist,expect(b).to.be.false,a()})})}),it('calls each function with the binding of the composed function',function(a){var b={},c=null,d=null,g=async.compose(function(i,j){d=this,setTimeout(function(){j(null,3*i)})},function(i,j){c=this,setTimeout(function(){j(null,i+2)})});g.call(b,3,function(h,i){expect(h).to.not.exist,expect(i).to.eql(15),expect(c).to.equal(b),expect(d).to.equal(b),a()})})});