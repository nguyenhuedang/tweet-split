var gulp=require('gulp'),rename=require('gulp-rename'),uglify=require('gulp-uglify'),header=require('gulp-header'),concat=require('gulp-concat'),replace=require('gulp-replace'),fs=require('fs'),paths={componentsFile:'components.js',components:['components/**/*.js','!components/**/*.min.js'],main:['components/prism-core.js','components/prism-markup.js','components/prism-css.js','components/prism-clike.js','components/prism-javascript.js','plugins/file-highlight/prism-file-highlight.js'],plugins:['plugins/**/*.js','!plugins/**/*.min.js'],showLanguagePlugin:'plugins/show-language/prism-show-language.js',autoloaderPlugin:'plugins/autoloader/prism-autoloader.js',changelog:'CHANGELOG.md'};gulp.task('components',function(){return gulp.src(paths.components).pipe(uglify()).pipe(rename({suffix:'.min'})).pipe(gulp.dest('components'))}),gulp.task('build',function(){return gulp.src(paths.main).pipe(header('\n/* **********************************************\n     Begin <%= file.relative %>\n********************************************** */\n\n')).pipe(concat('prism.js')).pipe(gulp.dest('./'))}),gulp.task('plugins',['languages-plugins'],function(){return gulp.src(paths.plugins).pipe(uglify()).pipe(rename({suffix:'.min'})).pipe(gulp.dest('plugins'))}),gulp.task('watch',function(){gulp.watch(paths.components,['components','build']),gulp.watch(paths.plugins,['plugins','build'])}),gulp.task('languages-plugins',function(a){fs.readFile(paths.componentsFile,{encoding:'utf-8'},function(b,c){if(!b){c=c.replace(/^var\s+components\s*=\s*|;\s*$/g,'');try{c=JSON.parse(c);var d={},f={};for(var g in c.languages)if('meta'!==g){var h=c.languages[g].displayTitle||c.languages[g].title,i=g.substring(0,1).toUpperCase()+g.substring(1);for(var j in h!==i&&(d[g]=h),c.languages[g].aliasTitles)d[j]=c.languages[g].aliasTitles[j];c.languages[g].require&&(f[g]=c.languages[g].require)}var k=JSON.stringify(d),m=JSON.stringify(f),n=[{plugin:paths.showLanguagePlugin,map:k},{plugin:paths.autoloaderPlugin,map:m}],o=0,q=n.length,r=function(){o++,o===q&&a&&a()};n.forEach(function(s){var t=gulp.src(s.plugin).pipe(replace(/\/\*languages_placeholder\[\*\/[\s\S]*?\/\*\]\*\//,'/*languages_placeholder[*/'+s.map+'/*]*/')).pipe(gulp.dest(s.plugin.substring(0,s.plugin.lastIndexOf('/'))));t.on('error',r),t.on('end',r)})}catch(s){a(s)}}else a(b)})}),gulp.task('changelog',function(){return gulp.src(paths.changelog).pipe(replace(/#(\d+)(?![\d\]])/g,'[#$1](https://github.com/PrismJS/prism/issues/$1)')).pipe(replace(/\[[\da-f]+(?:, *[\da-f]+)*\]/g,function(b){return b.replace(/([\da-f]{7})[\da-f]*/g,'[`$1`](https://github.com/PrismJS/prism/commit/$1)')})).pipe(gulp.dest('.'))}),gulp.task('default',['components','plugins','build']);