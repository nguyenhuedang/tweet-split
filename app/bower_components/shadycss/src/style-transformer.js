'use strict';import{StyleNode}from'./css-parse.js';import*as StyleUtil from'./style-util.js';import{nativeShadow}from'./style-settings.js';var SCOPE_NAME='style-scope',StyleTransformer=function(){function a(){babelHelpers.classCallCheck(this,a)}return babelHelpers.createClass(a,[{key:'dom',value:function(d,e,f){d.__styleScoped?d.__styleScoped=null:this._transformDom(d,e||'',f)}},{key:'_transformDom',value:function(d,e,f){d.nodeType===Node.ELEMENT_NODE&&this.element(d,e,f);var g='template'===d.localName?(d.content||d._content).childNodes:d.children||d.childNodes;if(g)for(var h=0;h<g.length;h++)this._transformDom(g[h],e,f)}},{key:'element',value:function(d,e,f){if(e)if(d.classList)f?(d.classList.remove(SCOPE_NAME),d.classList.remove(e)):(d.classList.add(SCOPE_NAME),d.classList.add(e));else if(d.getAttribute){var g=d.getAttribute(CLASS);if(!f){var j=(g?g+' ':'')+SCOPE_NAME+' '+e;StyleUtil.setElementClassRaw(d,j)}else if(g){var h=g.replace(SCOPE_NAME,'').replace(e,'');StyleUtil.setElementClassRaw(d,h)}}}},{key:'elementStyles',value:function(d,e,f){var g=d.__cssBuild,h='';if(nativeShadow||'shady'===g)h=StyleUtil.toCssText(e,f);else{var j=StyleUtil.getIsExtends(d),k=j.is,n=j.typeExtension;h=this.css(e,k,n,f)+'\n\n'}return h.trim()}},{key:'css',value:function(d,e,f,g){var h=this._calcHostScope(e,f);e=this._calcElementScope(e);var j=this;return StyleUtil.toCssText(d,function(k){k.isScoped||(j.rule(k,e,h),k.isScoped=!0),g&&g(k,e,h)})}},{key:'_calcElementScope',value:function(d){return d?CSS_CLASS_PREFIX+d:''}},{key:'_calcHostScope',value:function(d,e){return e?'[is='+d+']':d}},{key:'rule',value:function(d,e,f){this._transformRule(d,this._transformComplexSelector,e,f)}},{key:'_transformRule',value:function(d,e,f,g){d.selector=d.transformedSelector=this._transformRuleCss(d,e,f,g)}},{key:'_transformRuleCss',value:function(d,e,f,g){var h=d.selector.split(COMPLEX_SELECTOR_SEP);if(!StyleUtil.isKeyframesSelector(d))for(var n,j=0,k=h.length;j<k&&(n=h[j]);j++)h[j]=e.call(this,n,f,g);return h.join(COMPLEX_SELECTOR_SEP)}},{key:'_transformComplexSelector',value:function(d,e,f){var g=this,h=!1;return d=d.trim(),d=d.replace(NTH,function(j,k,n){return':'+k+'('+n.replace(/\s/g,'')+')'}),d=d.replace(SLOTTED_START,HOST+' $1'),d=d.replace(SIMPLE_SELECTOR_SEP,function(j,k,n){if(!h){var o=g._transformCompoundSelector(n,k,e,f);h=h||o.stop,k=o.combinator,n=o.value}return k+n}),d}},{key:'_transformCompoundSelector',value:function(d,e,f,g){var h=d.indexOf(SLOTTED);0<=d.indexOf(HOST)?d=this._transformHostSelector(d,g):0!==h&&(d=f?this._transformSimpleSelector(d,f):d);var j=!1;0<=h&&(e='',j=!0);var k;return j&&(k=!0,j&&(d=d.replace(SLOTTED_PAREN,function(n,o){return' > '+o}))),d=d.replace(DIR_PAREN,function(n,o,q){return'[dir="'+q+'"] '+o+', '+o+'[dir="'+q+'"]'}),{value:d,combinator:e,stop:k}}},{key:'_transformSimpleSelector',value:function(d,e){var f=d.split(PSEUDO_PREFIX);return f[0]+=e,f.join(PSEUDO_PREFIX)}},{key:'_transformHostSelector',value:function(d,e){var f=d.match(HOST_PAREN),g=f&&f[2].trim()||'';if(g){if(!g[0].match(SIMPLE_SELECTOR_PREFIX)){var h=g.split(SIMPLE_SELECTOR_PREFIX)[0];return h===e?g:SELECTOR_NO_MATCH}return d.replace(HOST_PAREN,function(j,k,n){return e+n})}return d.replace(HOST,e)}},{key:'documentRule',value:function(d){d.selector=d.parsedSelector,this.normalizeRootSelector(d),this._transformRule(d,this._transformDocumentSelector)}},{key:'normalizeRootSelector',value:function(d){d.selector===ROOT&&(d.selector='html')}},{key:'_transformDocumentSelector',value:function(d){return d.match(SLOTTED)?this._transformComplexSelector(d,SCOPE_DOC_SELECTOR):this._transformSimpleSelector(d.trim(),SCOPE_DOC_SELECTOR)}},{key:'SCOPE_NAME',get:function(){return SCOPE_NAME}}]),a}(),NTH=/:(nth[-\w]+)\(([^)]+)\)/,SCOPE_DOC_SELECTOR=':not(.'+SCOPE_NAME+')',COMPLEX_SELECTOR_SEP=',',SIMPLE_SELECTOR_SEP=/(^|[\s>+~]+)((?:\[.+?\]|[^\s>+~=\[])+)/g,SIMPLE_SELECTOR_PREFIX=/[[.:#*]/,HOST=':host',ROOT=':root',SLOTTED='::slotted',SLOTTED_START=/^(::slotted)/,HOST_PAREN=/(:host)(?:\(((?:\([^)(]*\)|[^)(]*)+?)\))/,SLOTTED_PAREN=/(?:::slotted)(?:\(((?:\([^)(]*\)|[^)(]*)+?)\))/,DIR_PAREN=/(.*):dir\((?:(ltr|rtl))\)/,CSS_CLASS_PREFIX='.',PSEUDO_PREFIX=':',CLASS='class',SELECTOR_NO_MATCH='should_not_match';export default new StyleTransformer;