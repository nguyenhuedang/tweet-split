'use strict';import{removeCustomPropAssignment,StyleNode}from'./css-parse.js';import{nativeShadow}from'./style-settings.js';import StyleTransformer from'./style-transformer.js';import*as StyleUtil from'./style-util.js';import*as RX from'./common-regex.js';import StyleInfo from'./style-info.js';var matchesSelector=function(a){return a.matches||a.matchesSelector||a.mozMatchesSelector||a.msMatchesSelector||a.oMatchesSelector||a.webkitMatchesSelector}(window.Element.prototype),IS_IE=navigator.userAgent.match('Trident'),XSCOPE_NAME='x-scope',StyleProperties=function(){function a(){babelHelpers.classCallCheck(this,a)}return babelHelpers.createClass(a,[{key:'decorateStyles',value:function(d){var e=this,f={},g=[],h=0;StyleUtil.forEachRule(d,function(q){e.decorateRule(q),q.index=h++,e.collectPropertiesInCssText(q.propertyInfo.cssText,f)},function(r){g.push(r)}),d._keyframes=g;var j=[];for(var k in f)j.push(k);return j}},{key:'decorateRule',value:function(d){if(d.propertyInfo)return d.propertyInfo;var e={},f={},g=this.collectProperties(d,f);return g&&(e.properties=f,d.rules=null),e.cssText=this.collectCssText(d),d.propertyInfo=e,e}},{key:'collectProperties',value:function(d,e){var f=d.propertyInfo;if(!f){for(var g,k,q,h=RX.VAR_ASSIGN,j=d.parsedCssText;g=h.exec(j);)k=(g[2]||g[3]).trim(),('inherit'!==k||'unset'!==k)&&(e[g[1].trim()]=k),q=!0;return q}return f.properties?(Object.assign(e,f.properties),!0):void 0}},{key:'collectCssText',value:function(d){return this.collectConsumingCssText(d.parsedCssText)}},{key:'collectConsumingCssText',value:function(d){return d.replace(RX.BRACKETED,'').replace(RX.VAR_ASSIGN,'')}},{key:'collectPropertiesInCssText',value:function(d,e){for(var f,g;f=RX.VAR_CONSUMED.exec(d);)g=f[1],':'!==f[2]&&(e[g]=!0)}},{key:'reify',value:function(d){for(var g,e=Object.getOwnPropertyNames(d),f=0;f<e.length;f++)g=e[f],d[g]=this.valueForProperty(d[g],d)}},{key:'valueForProperty',value:function(d,e){if(d)if(0<=d.indexOf(';'))d=this.valueForProperties(d,e);else{var f=this,g=function(j,k,q,r){if(!k)return j+r;var t=f.valueForProperty(e[k],e);return t&&'initial'!==t?'apply-shim-inherit'===t&&(t='inherit'):t=f.valueForProperty(e[q]||q,e)||q,j+(t||'')+r};d=StyleUtil.processVariableAndFallback(d,g)}return d&&d.trim()||''}},{key:'valueForProperties',value:function(d,e){for(var h,j,f=d.split(';'),g=0;g<f.length;g++)if(h=f[g]){if(RX.MIXIN_MATCH.lastIndex=0,j=RX.MIXIN_MATCH.exec(h),j)h=this.valueForProperty(e[j[1]],e);else{var k=h.indexOf(':');if(-1!==k){var q=h.substring(k);q=q.trim(),q=this.valueForProperty(q,e)||q,h=h.substring(0,k)+q}}f[g]=h&&h.lastIndexOf(';')===h.length-1?h.slice(0,-1):h||''}return f.join(';')}},{key:'applyProperties',value:function(d,e){var f='';d.propertyInfo||this.decorateRule(d),d.propertyInfo.cssText&&(f=this.valueForProperties(d.propertyInfo.cssText,e)),d.cssText=f}},{key:'applyKeyframeTransforms',value:function(d,e){var f=d.cssText,g=d.cssText;if(null==d.hasAnimations&&(d.hasAnimations=RX.ANIMATION_MATCH.test(f)),d.hasAnimations){var h;if(null==d.keyframeNamesToTransform)for(var j in d.keyframeNamesToTransform=[],e)h=e[j],g=h(f),f!==g&&(f=g,d.keyframeNamesToTransform.push(j));else{for(var k=0;k<d.keyframeNamesToTransform.length;++k)h=e[d.keyframeNamesToTransform[k]],f=h(f);g=f}}d.cssText=g}},{key:'propertyDataFromStyles',value:function(d,e){var f={},g=this,h=[];return StyleUtil.forEachRule(d,function(j){j.propertyInfo||g.decorateRule(j);var k=j.transformedSelector||j.parsedSelector;e&&j.propertyInfo.properties&&k&&matchesSelector.call(e,k)&&(g.collectProperties(j,f),addToBitMask(j.index,h))},null,!0),{properties:f,key:h}}},{key:'whenHostOrRootRule',value:function(d,e,f,g){if(e.propertyInfo||this.decorateRule(e),!!e.propertyInfo.properties){var h=StyleUtil.getIsExtends(d),j=h.is,k=h.typeExtension,q=j?StyleTransformer._calcHostScope(j,k):'html',r=e.parsedSelector,t=':host > *'===r||'html'===r,u=0===r.indexOf(':host')&&!t;if('shady'===f&&(t=r===q+' > *.'+q||-1!==r.indexOf('html'),u=!t&&0===r.indexOf(q)),'shadow'===f&&(t=':host > *'===r||'html'===r,u=u&&!t),t||u){var w=q;u&&(nativeShadow&&!e.transformedSelector&&(e.transformedSelector=StyleTransformer._transformRuleCss(e,StyleTransformer._transformComplexSelector,StyleTransformer._calcElementScope(j),q)),w=e.transformedSelector||q),g({selector:w,isHost:u,isRoot:t})}}}},{key:'hostAndRootPropertiesForScope',value:function(d,e){var f={},g={},h=this,j=e&&e.__cssBuild;return StyleUtil.forEachRule(e,function(k){h.whenHostOrRootRule(d,k,j,function(q){var r=d._element||d;matchesSelector.call(r,q.selector)&&(q.isHost?h.collectProperties(k,f):h.collectProperties(k,g))})},null,!0),{rootProps:g,hostProps:f}}},{key:'transformStyles',value:function(d,e,f){var g=this,h=StyleUtil.getIsExtends(d),j=h.is,k=h.typeExtension,q=StyleTransformer._calcHostScope(j,k),r=d.extends?'\\'+q.slice(0,-1)+'\\]':q,t=new RegExp(RX.HOST_PREFIX+r+RX.HOST_SUFFIX),u=StyleInfo.get(d).styleRules,w=this._elementKeyframeTransforms(d,u,f);return StyleTransformer.elementStyles(d,u,function(x){g.applyProperties(x,e),nativeShadow||StyleUtil.isKeyframesSelector(x)||!x.cssText||(g.applyKeyframeTransforms(x,w),g._scopeSelector(x,t,q,f))})}},{key:'_elementKeyframeTransforms',value:function(d,e,f){var g=e._keyframes,h={};if(!nativeShadow&&g)for(var j=0,k=g[j];j<g.length;k=g[++j])this._scopeKeyframes(k,f),h[k.keyframesName]=this._keyframesRuleTransformer(k);return h}},{key:'_keyframesRuleTransformer',value:function(d){return function(e){return e.replace(d.keyframesNameRx,d.transformedKeyframesName)}}},{key:'_scopeKeyframes',value:function(d,e){d.keyframesNameRx=new RegExp(d.keyframesName,'g'),d.transformedKeyframesName=d.keyframesName+'-'+e,d.transformedSelector=d.transformedSelector||d.selector,d.selector=d.transformedSelector.replace(d.keyframesName,d.transformedKeyframesName)}},{key:'_scopeSelector',value:function(d,e,f,g){d.transformedSelector=d.transformedSelector||d.selector;for(var t,h=d.transformedSelector,j='.'+g,k=h.split(','),q=0,r=k.length;q<r&&(t=k[q]);q++)k[q]=t.match(e)?t.replace(f,j):j+' '+t;d.selector=k.join(',')}},{key:'applyElementScopeSelector',value:function(d,e,f){var g=d.getAttribute('class')||'',h=g;f&&(h=g.replace(new RegExp('\\s*'+XSCOPE_NAME+'\\s*'+f+'\\s*','g'),' ')),h+=(h?' ':'')+XSCOPE_NAME+' '+e,g!==h&&StyleUtil.setElementClassRaw(d,h)}},{key:'applyElementStyle',value:function(d,e,f,g){var h=g?g.textContent||'':this.transformStyles(d,e,f),j=StyleInfo.get(d),k=j.customStyle;return k&&!nativeShadow&&k!==g&&(k._useCount--,0>=k._useCount&&k.parentNode&&k.parentNode.removeChild(k)),nativeShadow?j.customStyle?(j.customStyle.textContent=h,g=j.customStyle):h&&(g=StyleUtil.applyCss(h,f,d.shadowRoot,j.placeholder)):g?!g.parentNode&&(IS_IE&&-1<h.indexOf('@media')&&(g.textContent=h),StyleUtil.applyStyle(g,null,j.placeholder)):h&&(g=StyleUtil.applyCss(h,f,null,j.placeholder)),g&&(g._useCount=g._useCount||0,j.customStyle!=g&&g._useCount++,j.customStyle=g),g}},{key:'applyCustomStyle',value:function(d,e){var f=StyleUtil.rulesForStyle(d),g=this;d.textContent=StyleUtil.toCssText(f,function(h){var j=h.cssText=h.parsedCssText;h.propertyInfo&&h.propertyInfo.cssText&&(j=removeCustomPropAssignment(j),h.cssText=g.valueForProperties(j,e))})}},{key:'XSCOPE_NAME',get:function(){return XSCOPE_NAME}}]),a}();function addToBitMask(a,b){var d=parseInt(a/32,10);b[d]=(b[d]||0)|1<<a%32}export default new StyleProperties;