'use strict';import{forEachRule,processVariableAndFallback,rulesForStyle,toCssText}from'./style-util.js';import{MIXIN_MATCH,VAR_ASSIGN}from'./common-regex.js';import{detectMixin as _detectMixin}from'./common-utils.js';import{StyleNode}from'./css-parse.js';var APPLY_NAME_CLEAN=/;\s*/m,INITIAL_INHERIT=/^\s*(initial)|(inherit)\s*$/,MIXIN_VAR_SEP='_-_',PropertyEntry,DependantsEntry,MixinMapEntry,MixinMap=function(){function a(){babelHelpers.classCallCheck(this,a),this._map={}}return babelHelpers.createClass(a,[{key:'set',value:function(c,d){c=c.trim(),this._map[c]={properties:d,dependants:{}}}},{key:'get',value:function(c){return c=c.trim(),this._map[c]||null}}]),a}(),invalidCallback=null,ApplyShim=function(){function a(){babelHelpers.classCallCheck(this,a),this._currentElement=null,this._measureElement=null,this._map=new MixinMap}return babelHelpers.createClass(a,[{key:'detectMixin',value:function(c){return _detectMixin(c)}},{key:'transformTemplate',value:function(c,d){var e=c.content.querySelector('style'),g=null;return e&&(g=this.transformStyle(e,d)),g}},{key:'transformStyle',value:function(c){var d=1<arguments.length&&void 0!==arguments[1]?arguments[1]:'',e=rulesForStyle(c);return this.transformRules(e,d),c.textContent=toCssText(e),e}},{key:'transformCustomStyle',value:function(c){var d=this,e=rulesForStyle(c);return forEachRule(e,function(g){':root'===g.selector&&(g.selector='html'),d.transformRule(g)}),c.textContent=toCssText(e),e}},{key:'transformRules',value:function(c,d){var e=this;this._currentElement=d,forEachRule(c,function(g){e.transformRule(g)}),this._currentElement=null}},{key:'transformRule',value:function(c){c.cssText=this.transformCssText(c.parsedCssText),':root'===c.selector&&(c.selector=':host > *')}},{key:'transformCssText',value:function(c){var d=this;return c=c.replace(VAR_ASSIGN,function(e,g,h,j){return d._produceCssProperties(e,g,h,j)}),this._consumeCssProperties(c)}},{key:'_getInitialValueForProperty',value:function(c){return this._measureElement||(this._measureElement=document.createElement('meta'),this._measureElement.setAttribute('apply-shim-measure',''),this._measureElement.style.all='initial',document.head.appendChild(this._measureElement)),window.getComputedStyle(this._measureElement).getPropertyValue(c)}},{key:'_consumeCssProperties',value:function(c){for(var d=null;d=MIXIN_MATCH.exec(c);){var e=d[0],g=d[1],h=d.index,j=h+e.indexOf('@apply'),k=h+e.length,l=c.slice(0,j),n=c.slice(k),o=this._cssTextToMap(l),q=this._atApplyToCssProperties(g,o);c=''+l+q+n,MIXIN_MATCH.lastIndex=h+q.length}return c}},{key:'_atApplyToCssProperties',value:function(c,d){c=c.replace(APPLY_NAME_CLEAN,'');var e=[],g=this._map.get(c);if(g||(this._map.set(c,{}),g=this._map.get(c)),g){this._currentElement&&(g.dependants[this._currentElement]=!0);var h,j,k;for(h in g.properties)k=d&&d[h],j=[h,': var(',c,MIXIN_VAR_SEP,h],k&&j.push(',',k),j.push(')'),e.push(j.join(''))}return e.join('; ')}},{key:'_replaceInitialOrInherit',value:function(c,d){var e=INITIAL_INHERIT.exec(d);return e&&(e[1]?d=this._getInitialValueForProperty(c):d='apply-shim-inherit'),d}},{key:'_cssTextToMap',value:function(c){for(var k,l,d=c.split(';'),e=void 0,g=void 0,h={},j=0;j<d.length;j++)k=d[j],k&&(l=k.split(':'),1<l.length&&(e=l[0].trim(),g=this._replaceInitialOrInherit(e,l.slice(1).join(':')),h[e]=g));return h}},{key:'_invalidateMixinEntry',value:function(c){if(invalidCallback)for(var d in c.dependants)d!==this._currentElement&&invalidCallback(d)}},{key:'_produceCssProperties',value:function(c,d,e,g){var h=this;if(e&&processVariableAndFallback(e,function(x,y){y&&h._map.get(y)&&(g='@apply '+y+';')}),!g)return c;var j=this._consumeCssProperties(g),k=c.slice(0,c.indexOf('--')),l=this._cssTextToMap(j),n=l,o=this._map.get(d),q=o&&o.properties;q?n=Object.assign(Object.create(q),l):this._map.set(d,n);var t,u,s=[],w=!1;for(t in n)u=l[t],void 0===u&&(u='initial'),q&&!(t in q)&&(w=!0),s.push(''+d+MIXIN_VAR_SEP+t+': '+u);return w&&this._invalidateMixinEntry(o),o&&(o.properties=n),e&&(k=c+';'+k),''+k+s.join('; ')+';'}}]),a}();ApplyShim.prototype.detectMixin=ApplyShim.prototype.detectMixin,ApplyShim.prototype.transformStyle=ApplyShim.prototype.transformStyle,ApplyShim.prototype.transformCustomStyle=ApplyShim.prototype.transformCustomStyle,ApplyShim.prototype.transformRules=ApplyShim.prototype.transformRules,ApplyShim.prototype.transformRule=ApplyShim.prototype.transformRule,ApplyShim.prototype.transformTemplate=ApplyShim.prototype.transformTemplate,ApplyShim.prototype._separator=MIXIN_VAR_SEP,Object.defineProperty(ApplyShim.prototype,'invalidCallback',{get:function(){return invalidCallback},set:function(b){invalidCallback=b}});export default ApplyShim;